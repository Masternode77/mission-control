export async function sendTelegramMessage(text: string): Promise<Response | null> {
  const token = process.env.TELEGRAM_BOT_TOKEN;
  const chatId = process.env.TELEGRAM_CHAT_ID;
  if (!token || !chatId) return null;

  return fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      chat_id: chatId,
      text,
      disable_web_page_preview: true,
    }),
  });
}

export async function sendTelegramReply(params: {
  chatId: string | number;
  text: string;
  replyToMessageId?: number;
}): Promise<Response | null> {
  const token = process.env.TELEGRAM_BOT_TOKEN;
  if (!token) return null;

  const payload: any = {
    chat_id: params.chatId,
    text: params.text,
    disable_web_page_preview: true,
  };

  if (params.replyToMessageId) {
    payload.reply_parameters = { message_id: params.replyToMessageId };
  }

  return fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload),
  });
}

export function buildHitlTelegramSummary(taskId: string, title: string, draft: string) {
  const lines = draft.split('\n').map((l) => l.trim()).filter(Boolean);
  const core = lines.slice(0, 3).map((l) => `â€¢ ${l}`).join('\n') || 'â€¢ ìš”ì•½ ì—†ìŒ';

  const riskLine = lines.find((l) => /risk|ë¦¬ìŠ¤í¬/i.test(l)) || 'ë¦¬ìŠ¤í¬: í™•ì¸ í•„ìš”';
  const altLine = lines.find((l) => /alternative|ëŒ€ì•ˆ/i.test(l)) || 'ëŒ€ì•ˆ: ì¶”ê°€ ê²€í†  í•„ìš”';

  return [
    `ğŸŸ  HITL ìŠ¹ì¸ ëŒ€ê¸°`,
    `Task: ${taskId}`,
    `ì œëª©: ${title}`,
    '',
    '[í•µì‹¬ 3ì¤„ ìš”ì•½]',
    core,
    '',
    '[ë¦¬ìŠ¤í¬/ëŒ€ì•ˆ]',
    `${riskLine}`,
    `${altLine}`,
  ].join('\n');
}
